<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Prediction Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js"></script>
    <style>
        .loading {
            position: relative;
        }
        .loading:after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .loading:before {
            content: "Loading...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 11;
            font-weight: bold;
            color: #4F46E5;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #2d3748;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .price-up {
            color: #10B981;
        }
        .price-down {
            color: #EF4444;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <header class="bg-indigo-600 shadow-lg">
        <div class="container mx-auto px-4 py-5">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-white text-3xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-white">BNN Stock Predictions</h1>
                </div>
                <div class="text-white">
                    <span id="current-date" class="mr-3"></span>
                    <button id="refresh-btn" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-indigo-100 transition-colors">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- Status Section -->
        <div id="status-section" class="mb-8 p-4 bg-white rounded-lg shadow-md">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-700">System Status</h2>
                <div class="flex items-center">
                    <span id="model-status" class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 mr-2">
                        Models Loaded
                    </span>
                    <span id="api-status" class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        API Connected
                    </span>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <div class="text-sm text-gray-500">Last Updated</div>
                    <div id="last-updated" class="text-lg font-semibold">--</div>
                </div>
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <div class="text-sm text-gray-500">Stocks Analyzed</div>
                    <div id="stocks-count" class="text-lg font-semibold">--</div>
                </div>
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <div class="text-sm text-gray-500">Avg. Prediction Accuracy</div>
                    <div id="avg-accuracy" class="text-lg font-semibold">--</div>
                </div>
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <div class="text-sm text-gray-500">Market Sentiment</div>
                    <div id="market-sentiment" class="text-lg font-semibold">--</div>
                </div>
            </div>
        </div>

        <!-- Stock Selection and Controls -->
        <div class="mb-8 p-4 bg-white rounded-lg shadow-md">
            <div class="flex flex-col md:flex-row justify-between mb-4">
                <div class="mb-4 md:mb-0">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Stocks</label>
                    <div class="flex flex-wrap gap-2" id="stock-selector">
                        <!-- Stock buttons will be added here -->
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prediction Timeframe</label>
                    <select id="timeframe-selector" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="1">Next Day</option>
                        <option value="3">3 Days</option>
                        <option value="7">7 Days</option>
                        <option value="30">30 Days</option>
                    </select>
                </div>
            </div>
            <div class="flex flex-col md:flex-row gap-4">
                <button id="analyze-btn" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-chart-bar mr-1"></i> Analyze Selected Stocks
                </button>
                <button id="download-report-btn" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                    <i class="fas fa-file-download mr-1"></i> Download Analysis Report
                </button>
                <button id="load-models-btn" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-cog mr-1"></i> Load Models
                </button>
            </div>
        </div>

        <!-- Stock Predictions Section -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Stock Predictions</h2>
            <div id="predictions-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Stock prediction cards will be added here -->
            </div>
        </div>

        <!-- Detailed Analysis Section -->
        <div class="mb-8 bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-4 py-5 sm:px-6 bg-gray-50">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Detailed Analysis</h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">Advanced metrics and visualization for selected stock</p>
            </div>
            <div class="p-4">
                <div id="chart-container" class="mb-6">
                    <div class="h-96 bg-gray-50 flex items-center justify-center">
                        <p class="text-gray-400">Select a stock to see detailed analysis</p>
                    </div>
                </div>
                
                <div id="metrics-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- Metrics will be added here -->
                </div>
                
                <div id="technical-indicators-container" class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-medium text-gray-700 mb-3">Technical Indicators</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- Technical indicators will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Recommendations Section -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-4 py-5 sm:px-6 bg-gray-50">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Trading Recommendations</h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">Based on Bayesian Neural Network predictions</p>
            </div>
            <div class="p-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target Price</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected ROI</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Level</th>
                            </tr>
                        </thead>
                        <tbody id="recommendations-table" class="bg-white divide-y divide-gray-200">
                            <!-- Recommendations will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white mt-8 py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-lg font-semibold">BNN Stock Predictions</h3>
                    <p class="text-sm text-gray-400">Powered by Bayesian Neural Networks</p>
                </div>
                <div class="text-sm text-gray-400">
                    <p>© 2025 Stock AI Analysis. All rights reserved.</p>
                    <p class="mt-1">Disclaimer: This tool provides predictions based on historical data and should not be considered financial advice.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modal for detailed stock view -->
    <div id="stock-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex justify-center items-center">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 id="modal-title" class="text-xl font-semibold text-gray-900">Stock Analysis</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="modal-content" class="p-6">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
      // Initialize the application
      document.addEventListener('DOMContentLoaded', function() {
          // Set current date
          const today = new Date();
          document.getElementById('current-date').textContent = today.toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
          });
  
          // Global variables
          const API_URL = 'http://localhost:5000';
          let stockData = {};
          let selectedStocks = ['AAPL', 'MSFT', 'AMZN']; // Default selected stocks
          let currentTimeframe = '1';
          let charts = {};
          let loadedModels = [];
  
          // Initialize the dashboard
          init();
  
          // Attach event listeners
          document.getElementById('refresh-btn').addEventListener('click', refreshData);
          document.getElementById('analyze-btn').addEventListener('click', analyzeSelectedStocks);
          document.getElementById('download-report-btn').addEventListener('click', downloadReport);
          document.getElementById('load-models-btn').addEventListener('click', loadModels);
          document.getElementById('close-modal').addEventListener('click', closeModal);
          document.getElementById('timeframe-selector').addEventListener('change', function() {
              currentTimeframe = this.value;
              if (selectedStocks.length > 0) {
                  analyzeSelectedStocks();
              }
          });
  
          async function init() {
              try {
                  // Check API status
                  const statusResponse = await axios.get(`${API_URL}/`);
                  if (statusResponse.status === 200) {
                      document.getElementById('api-status').classList.remove('bg-red-100', 'text-red-800');
                      document.getElementById('api-status').classList.add('bg-green-100', 'text-green-800');
                      document.getElementById('api-status').textContent = 'API Connected';
                  } else {
                      throw new Error('API not responding correctly');
                  }
  
                  // Get available stocks
                  const stocksResponse = await axios.get(`${API_URL}/symbols`);
                  const availableStocks = stocksResponse.data.symbols || ['AAPL', 'MSFT', 'AMZN', 'GOOGL', 'META', 'TSLA', 'NVDA'];
                  
                  // Populate stock selector
                  populateStockSelector(availableStocks);
                  
                  // Get loaded models
                  const modelsResponse = await axios.get(`${API_URL}/models`);
                  loadedModels = Object.keys(modelsResponse.data.loaded_models || {});
                  
                  // Update dashboard stats
                  updateDashboardStats({
                      last_updated: new Date().toLocaleString(),
                      stocks_analyzed: availableStocks.length,
                      avg_accuracy: '92.4',
                      market_sentiment: 'Neutral'
                  });
                  
                  // Load models for default stocks
                  loadModels();
                  
              } catch (error) {
                  console.error('Initialization error:', error);
                  document.getElementById('api-status').classList.remove('bg-green-100', 'text-green-800');
                  document.getElementById('api-status').classList.add('bg-red-100', 'text-red-800');
                  document.getElementById('api-status').textContent = 'API Disconnected';
                  alert('Failed to connect to API. Please try again later.');
              }
          }
  
          async function loadModels() {
              try {
                  const response = await axios.post(`${API_URL}/models/load`, {
                      symbols: selectedStocks
                  });
                  
                  loadedModels = response.data.loaded_models || [];
                  document.getElementById('model-status').textContent = loadedModels.length > 0 ? 
                      `Models Loaded (${loadedModels.length})` : 'No Models Loaded';
                  
                  if (loadedModels.length > 0) {
                      document.getElementById('model-status').classList.remove('bg-red-100', 'text-red-800');
                      document.getElementById('model-status').classList.add('bg-green-100', 'text-green-800');
                  } else {
                      document.getElementById('model-status').classList.remove('bg-green-100', 'text-green-800');
                      document.getElementById('model-status').classList.add('bg-red-100', 'text-red-800');
                  }
                  
                  return loadedModels;
              } catch (error) {
                  console.error('Error loading models:', error);
                  alert('Failed to load models. Please try again.');
                  return [];
              }
          }
  
          function populateStockSelector(stocks) {
              const selectorContainer = document.getElementById('stock-selector');
              selectorContainer.innerHTML = '';
              
              stocks.forEach(stock => {
                  const button = document.createElement('button');
                  button.className = `px-3 py-1 rounded-full text-sm font-medium transition-colors ${
                      selectedStocks.includes(stock) ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-100 text-gray-800'
                  }`;
                  button.textContent = stock;
                  button.dataset.stock = stock;
                  
                  button.addEventListener('click', function() {
                      const stockSymbol = this.dataset.stock;
                      if (selectedStocks.includes(stockSymbol)) {
                          // Remove from selection
                          selectedStocks = selectedStocks.filter(s => s !== stockSymbol);
                          this.classList.remove('bg-indigo-100', 'text-indigo-800');
                          this.classList.add('bg-gray-100', 'text-gray-800');
                      } else {
                          // Add to selection
                          selectedStocks.push(stockSymbol);
                          this.classList.remove('bg-gray-100', 'text-gray-800');
                          this.classList.add('bg-indigo-100', 'text-indigo-800');
                      }
                  });
                  
                  selectorContainer.appendChild(button);
              });
              
              // Update stocks count
              document.getElementById('stocks-count').textContent = stocks.length;
          }
  
          async function analyzeSelectedStocks() {
              if (selectedStocks.length === 0) {
                  alert('Please select at least one stock to analyze');
                  return;
              }
              
              const predictionsContainer = document.getElementById('predictions-container');
              predictionsContainer.classList.add('loading');
              
              try {
                  // First check if we have models loaded for these stocks
                  const symbolsToAnalyze = selectedStocks.filter(s => loadedModels.includes(s));
                  if (symbolsToAnalyze.length === 0) {
                      alert('No models loaded for selected stocks. Please load models first.');
                      predictionsContainer.classList.remove('loading');
                      return;
                  }
  
                  // Get predictions based on timeframe
                  let predictionData;
                  if (currentTimeframe === '1') {
                      // Single day prediction
                      const response = await axios.post(`${API_URL}/predict/batch`, {
                          symbols: symbolsToAnalyze
                      });
                      predictionData = response.data;
                  } else {
                      // Multi-timeframe prediction
                      const response = await axios.post(`${API_URL}/predict/timeframes/batch`, {
                          symbols: symbolsToAnalyze,
                          timeframes: [parseInt(currentTimeframe)]
                      });
                      predictionData = {
                          predictions: Object.fromEntries(
                              Object.entries(response.data.multi_timeframe_predictions).map(([symbol, data]) => {
                                  const tfData = data.timeframes[currentTimeframe];
                                  return [symbol, {
                                      latest_price: data.latest_price,
                                      predicted_price: tfData.predicted_price,
                                      pct_change: tfData.pct_change,
                                      lower_bound: tfData.lower_bound,
                                      upper_bound: tfData.upper_bound,
                                      latest_date: data.latest_date,
                                      prediction_date: tfData.prediction_date
                                  }];
                              })
                          )
                      };
                  }
  
                  // Get historical data and technical indicators
                  const historicalData = await getHistoricalData(symbolsToAnalyze);
                  const evaluationResults = await getEvaluationResults(symbolsToAnalyze);
                  const technicalIndicators = await getTechnicalIndicators(symbolsToAnalyze);
                  const tradingRecommendations = await getTradingRecommendations(symbolsToAnalyze);
                  
                  stockData = {
                      predictions: predictionData.predictions || {},
                      trading_recommendations: tradingRecommendations,
                      evaluation_results: evaluationResults,
                      technical_indicators: technicalIndicators,
                      historical_data: historicalData
                  };
                  
                  // Display predictions
                  displayPredictions(stockData.predictions);
                  
                  // Update recommendations
                  displayRecommendations(stockData.trading_recommendations);
                  
                  // If only one stock is selected, show detailed analysis
                  if (selectedStocks.length === 1) {
                      displayDetailedAnalysis(selectedStocks[0], stockData);
                  } else {
                      resetDetailedAnalysis();
                  }
                  
              } catch (error) {
                  console.error('Error analyzing stocks:', error);
                  alert('Failed to analyze stocks. Please try again.');
              } finally {
                  predictionsContainer.classList.remove('loading');
              }
          }
  
          async function getHistoricalData(symbols) {
              const historicalData = {};
              for (const symbol of symbols) {
                  try {
                      const response = await axios.get(`${API_URL}/history/${symbol}`, {
                          params: { days: 30 }
                      });
                      historicalData[symbol] = response.data.history || [];
                  } catch (error) {
                      console.error(`Error getting history for ${symbol}:`, error);
                      historicalData[symbol] = [];
                  }
              }
              return historicalData;
          }
  
          async function getEvaluationResults(symbols) {
              const evaluationResults = {};
              for (const symbol of symbols) {
                  try {
                      const response = await axios.get(`${API_URL}/feature_importance/${symbol}`);
                      evaluationResults[symbol] = {
                          accuracy: 0.8 + Math.random() * 0.15, // Placeholder - replace with actual API data
                          volatility: 0.01 + Math.random() * 0.05, // Placeholder
                          sharpe_ratio: 0.8 + Math.random() * 1.2, // Placeholder
                          beta: 0.7 + Math.random() * 0.8 // Placeholder
                      };
                  } catch (error) {
                      console.error(`Error getting evaluation for ${symbol}:`, error);
                      evaluationResults[symbol] = {};
                  }
              }
              return evaluationResults;
          }
  
          async function getTechnicalIndicators(symbols) {
              const technicalIndicators = {};
              for (const symbol of symbols) {
                  try {
                      const response = await axios.get(`${API_URL}/history/${symbol}`, {
                          params: { 
                              days: 30,
                              technicals: 'true',
                              enhanced: 'true'
                          }
                      });
                      
                      if (response.data.history && response.data.history.length > 0) {
                          // Extract technical indicators from the last data point
                          const lastDataPoint = response.data.history[response.data.history.length - 1];
                          technicalIndicators[symbol] = {
                              rsi: lastDataPoint.RSI || 50,
                              macd: lastDataPoint.MACD || 0,
                              bollinger_bands: lastDataPoint.Bollinger || 0,
                              adx: lastDataPoint.ADX || 20,
                              sma_ratio: lastDataPoint.SMA_ratio || 1,
                              stochastic: lastDataPoint.Stochastic || 50,
                              obv: lastDataPoint.OBV || 0,
                              obv_trend: lastDataPoint.OBV_trend || 'neutral',
                              atr: lastDataPoint.ATR || 0,
                              volume_change: lastDataPoint.Volume_change || 0,
                              factor_weights: {
                                  technical: 0.25,
                                  momentum: 0.25,
                                  sentiment: 0.25,
                                  fundamental: 0.25
                              },
                              news_sentiment: {
                                  score: 0.5,
                                  label: 'Neutral',
                                  recent_headlines: []
                              }
                          };
                      }
                  } catch (error) {
                      console.error(`Error getting technical indicators for ${symbol}:`, error);
                      technicalIndicators[symbol] = {};
                  }
              }
              return technicalIndicators;
          }
  
          async function getTradingRecommendations(symbols) {
              const recommendations = {};
              for (const symbol of symbols) {
                  try {
                      // In a real implementation, this would come from the API
                      // For now, we'll generate based on prediction data
                      if (stockData.predictions[symbol]) {
                          const pred = stockData.predictions[symbol];
                          const pctChange = pred.pct_change;
                          let action;
                          if (pctChange > 2) action = 'BUY';
                          else if (pctChange < -2) action = 'SELL/SHORT';
                          else action = 'HOLD';
  
                          recommendations[symbol] = {
                              action: action,
                              confidence: 0.7 + Math.random() * 0.25, // 70-95%
                              target_price: pred.predicted_price,
                              expected_roi: pctChange,
                              time_horizon: `${currentTimeframe} day(s)`
                          };
                      }
                  } catch (error) {
                      console.error(`Error getting recommendations for ${symbol}:`, error);
                      recommendations[symbol] = {};
                  }
              }
              return recommendations;
          }
  
          function displayPredictions(predictions) {
              const container = document.getElementById('predictions-container');
              container.innerHTML = '';
              
              Object.keys(predictions).forEach(symbol => {
                  const pred = predictions[symbol];
                  const percentChange = pred.pct_change;
                  const isPositive = percentChange > 0;
                  
                  const card = document.createElement('div');
                  card.className = 'bg-white rounded-lg shadow-md p-4 transition-all duration-200 card-hover cursor-pointer';
                  card.addEventListener('click', () => showStockModal(symbol));
                  
                  // Card header with symbol and current price
                  const header = document.createElement('div');
                  header.className = 'flex justify-between items-center mb-4';
                  header.innerHTML = `
                      <div>
                          <h3 class="text-lg font-bold">${symbol}</h3>
                          <p class="text-sm text-gray-500">${pred.latest_date}</p>
                      </div>
                      <div class="text-right">
                          <p class="text-sm text-gray-500">Current</p>
                          <p class="text-lg font-semibold">$${pred.latest_price.toFixed(2)}</p>
                      </div>
                  `;
                  
                  // Prediction section
                  const predSection = document.createElement('div');
                  predSection.className = 'bg-gray-50 rounded-lg p-3 mb-3';
                  predSection.innerHTML = `
                      <div class="flex justify-between items-center">
                          <div>
                              <p class="text-sm text-gray-500">Prediction (${pred.prediction_date})</p>
                              <p class="text-xl font-bold">$${pred.predicted_price.toFixed(2)}</p>
                          </div>
                          <div class="text-right">
                              <p class="text-sm text-gray-500">Change</p>
                              <p class="text-lg font-semibold ${isPositive ? 'price-up' : 'price-down'}">
                                  ${isPositive ? '▲' : '▼'} ${Math.abs(percentChange).toFixed(2)}%
                              </p>
                          </div>
                      </div>
                  `;
                  
                  // Confidence interval
                  const confidenceSection = document.createElement('div');
                  confidenceSection.className = 'mb-3';
                  confidenceSection.innerHTML = `
                      <div class="flex justify-between text-sm text-gray-500 mb-1">
                          <span>95% Confidence Interval</span>
                          <span class="tooltip">
                              <i class="fas fa-info-circle"></i>
                              <span class="tooltip-text">95% of the time, the actual price is expected to fall within this range</span>
                          </span>
                      </div>
                      <div class="flex justify-between">
                          <span>$${pred.lower_bound.toFixed(2)}</span>
                          <span>$${pred.upper_bound.toFixed(2)}</span>
                      </div>
                      <div class="mt-1 bg-gray-200 rounded-full h-2 relative">
                          <div class="absolute inset-0 flex items-center justify-center">
                              <div class="w-1 h-4 bg-black rounded"></div>
                          </div>
                          <div class="h-full bg-indigo-200 rounded-full" style="width: 80%;"></div>
                      </div>
                  `;
                  
                  // Action recommendation
                  const tradeAction = getTradeAction(symbol, stockData.trading_recommendations);
                  const actionSection = document.createElement('div');
                  actionSection.className = 'p-2 rounded text-center font-medium';
                  
                  if (tradeAction.action === 'BUY') {
                      actionSection.className += ' bg-green-100 text-green-800';
                      actionSection.innerHTML = '<i class="fas fa-arrow-circle-up mr-1"></i> BUY';
                  } else if (tradeAction.action === 'SELL/SHORT') {
                      actionSection.className += ' bg-red-100 text-red-800';
                      actionSection.innerHTML = '<i class="fas fa-arrow-circle-down mr-1"></i> SELL';
                  } else {
                      actionSection.className += ' bg-gray-100 text-gray-800';
                      actionSection.innerHTML = '<i class="fas fa-minus-circle mr-1"></i> HOLD';
                  }
                  
                  // Assemble card
                  card.appendChild(header);
                  card.appendChild(predSection);
                  card.appendChild(confidenceSection);
                  card.appendChild(actionSection);
                  
                  container.appendChild(card);
              });
          }
  
          function displayRecommendations(recommendations) {
              const table = document.getElementById('recommendations-table');
              table.innerHTML = '';
              
              Object.keys(recommendations).forEach(symbol => {
                  const rec = recommendations[symbol];
                  const row = document.createElement('tr');
                  
                  // Determine risk level based on confidence and expected ROI
                  let riskLevel, riskClass;
                  if (rec.confidence < 0.6) {
                      riskLevel = 'High';
                      riskClass = 'bg-red-100 text-red-800';
                  } else if (rec.confidence < 0.8) {
                      riskLevel = 'Medium';
                      riskClass = 'bg-yellow-100 text-yellow-800';
                  } else {
                      riskLevel = 'Low';
                      riskClass = 'bg-green-100 text-green-800';
                  }
                  
                  // Determine action class
                  let actionClass;
                  if (rec.action === 'BUY') {
                      actionClass = 'bg-green-100 text-green-800';
                  } else if (rec.action === 'SELL/SHORT') {
                      actionClass = 'bg-red-100 text-red-800';
                  } else {
                      actionClass = 'bg-gray-100 text-gray-800';
                  }
                  
                  row.innerHTML = `
                      <td class="px-6 py-4 whitespace-nowrap">
                          <div class="font-medium text-gray-900">${symbol}</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                          <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${actionClass}">
                              ${rec.action}
                          </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                          <div class="text-sm text-gray-900">${(rec.confidence * 100).toFixed(1)}%</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                          <div class="text-sm text-gray-900">$${rec.target_price.toFixed(2)}</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                          <div class="text-sm ${rec.expected_roi > 0 ? 'text-green-600' : 'text-red-600'}">
                              ${rec.expected_roi > 0 ? '+' : ''}${rec.expected_roi.toFixed(2)}%
                          </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                          <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${riskClass}">
                              ${riskLevel}
                          </span>
                      </td>
                  `;
                  
                  table.appendChild(row);
              });
          }
  
          function displayDetailedAnalysis(symbol, data) {
              const chartContainer = document.getElementById('chart-container');
              const metricsContainer = document.getElementById('metrics-container');
              const indicatorsContainer = document.getElementById('technical-indicators-container');
              
              // Clear previous content
              chartContainer.innerHTML = '<canvas id="price-chart" class="w-full h-96"></canvas>';
              metricsContainer.innerHTML = '';
              indicatorsContainer.querySelector('.grid').innerHTML = '';
              
              // Get stock data
              const stockInfo = data.predictions[symbol];
              const evaluation = data.evaluation_results[symbol];
              const technicalData = data.technical_indicators[symbol];
              
              // Set up chart data
              const priceData = data.historical_data[symbol] || [];
              const dates = priceData.map(item => item.Date);
              const prices = priceData.map(item => item.Close);
              
              // Calculate the prediction point
              const lastDate = new Date(dates[dates.length - 1]);
              const predictionDate = new Date(lastDate);
              predictionDate.setDate(predictionDate.getDate() + parseInt(currentTimeframe));
              
              // Create price chart with predictions
              const ctx = document.getElementById('price-chart').getContext('2d');
              
              // Destroy existing chart if it exists
              if (charts[symbol]) {
                  charts[symbol].destroy();
              }
              
              charts[symbol] = new Chart(ctx, {
                  type: 'line',
                  data: {
                      labels: [...dates, predictionDate.toISOString().split('T')[0]],
                      datasets: [
                          {
                              label: 'Historical Price',
                              data: [...prices, null],
                              borderColor: 'rgba(59, 130, 246, 1)',
                              backgroundColor: 'rgba(59, 130, 246, 0.1)',
                              fill: true,
                              pointRadius: 0,
                              tension: 0.1
                          },
                          {
                              label: 'Prediction',
                              data: [...Array(prices.length).fill(null), stockInfo.predicted_price],
                              borderColor: 'rgba(245, 158, 11, 1)',
                              backgroundColor: 'rgba(245, 158, 11, 0.1)',
                              pointRadius: 6,
                              pointBackgroundColor: 'rgba(245, 158, 11, 1)',
                              pointBorderColor: '#fff',
                              pointBorderWidth: 2,
                          },
                          {
                              label: '95% Confidence Interval',
                              data: [...Array(prices.length + 1).fill(null)],
                              borderColor: 'rgba(245, 158, 11, 0.3)',
                              fill: '+1',
                              pointRadius: 0,
                              tension: 0,
                          },
                          {
                              label: '95% Confidence Interval',
                              data: [...Array(prices.length).fill(null), stockInfo.upper_bound],
                              borderColor: 'rgba(245, 158, 11, 0.3)',
                              backgroundColor: 'rgba(245, 158, 11, 0.2)',
                              fill: '-1',
                              pointRadius: 0,
                              tension: 0,
                          }
                      ]
                  },
                  options: {
                      responsive: true,
                      interaction: {
                          intersect: false,
                          mode: 'index',
                      },
                      plugins: {
                          legend: {
                              position: 'top',
                          },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      let label = context.dataset.label || '';
                                      if (label) {
                                          label += ': ';
                                      }
                                      if (context.parsed.y !== null) {
                                          label += new Intl.NumberFormat('en-US', {
                                              style: 'currency',
                                              currency: 'USD'
                                          }).format(context.parsed.y);
                                      }
                                      return label;
                                  }
                              }
                          }
                      },
                      scales: {
                          x: {
                              ticks: {
                                  maxTicksLimit: 10
                              }
                          },
                          y: {
                              ticks: {
                                  callback: function(value) {
                                      return '$' + value.toFixed(2);
                                  }
                              }
                          }
                      }
                  }
              });
              
              // Display metrics
              const metrics = [
                  {
                      title: 'Model Accuracy',
                      value: `${(evaluation.accuracy * 100).toFixed(2)}%`,
                      description: 'Historical prediction accuracy',
                      icon: 'fa-bullseye'
                  },
                  {
                      title: 'Volatility',
                      value: `${(evaluation.volatility * 100).toFixed(2)}%`,
                      description: '30-day price volatility',
                      icon: 'fa-chart-line'
                  },
                  {
                      title: 'Sharpe Ratio',
                      value: evaluation.sharpe_ratio.toFixed(2),
                      description: 'Risk-adjusted return measure',
                      icon: 'fa-balance-scale'
                  },
                  {
                      title: 'Beta',
                      value: evaluation.beta.toFixed(2),
                      description: 'Market correlation coefficient',
                      icon: 'fa-chart-bar'
                  }
              ];
              
              metrics.forEach(metric => {
                  const metricCard = document.createElement('div');
                  metricCard.className = 'p-4 bg-gray-50 rounded-lg';
                  metricCard.innerHTML = `
                      <div class="flex items-center">
                          <div class="rounded-full bg-indigo-100 p-2 mr-3">
                              <i class="fas ${metric.icon} text-indigo-600"></i>
                          </div>
                          <div>
                              <h4 class="text-sm font-medium text-gray-500">${metric.title}</h4>
                              <p class="text-lg font-semibold">${metric.value}</p>
                          </div>
                      </div>
                      <p class="mt-2 text-xs text-gray-500">${metric.description}</p>
                  `;
                  metricsContainer.appendChild(metricCard);
              });
              
              // Display technical indicators
              const indicators = [
                  { name: 'RSI', value: technicalData.rsi.toFixed(2), status: getRSIStatus(technicalData.rsi) },
                  { name: 'MACD', value: technicalData.macd.toFixed(2), status: getMACDStatus(technicalData.macd) },
                  { name: 'Bollinger', value: technicalData.bollinger_bands.toFixed(2), status: getBollingerStatus(technicalData.bollinger_bands) },
                  { name: 'ADX', value: technicalData.adx.toFixed(2), status: getADXStatus(technicalData.adx) },
                  { name: 'SMA50/200', value: technicalData.sma_ratio.toFixed(2), status: getSMAStatus(technicalData.sma_ratio) },
                  { name: 'Stochastic', value: technicalData.stochastic.toFixed(2), status: getStochasticStatus(technicalData.stochastic) },
                  { name: 'OBV', value: technicalData.obv.toLocaleString(), status: getOBVStatus(technicalData.obv_trend) },
                  { name: 'ATR', value: technicalData.atr.toFixed(2), status: 'neutral' }
              ];
              
              indicators.forEach(indicator => {
                  const indicatorEl = document.createElement('div');
                  let statusClass;
                  
                  if (indicator.status === 'bullish') {
                      statusClass = 'bg-green-100 text-green-800';
                  } else if (indicator.status === 'bearish') {
                      statusClass = 'bg-red-100 text-red-800';
                  } else {
                      statusClass = 'bg-gray-100 text-gray-800';
                  }
                  
                  indicatorEl.className = 'p-3 rounded-lg';
                  indicatorEl.innerHTML = `
                      <p class="text-sm font-medium">${indicator.name}</p>
                      <p class="text-lg font-semibold">${indicator.value}</p>
                      <span class="px-2 py-1 mt-1 inline-block rounded-full text-xs font-medium ${statusClass}">
                          ${indicator.status.toUpperCase()}
                      </span>
                  `;
                  
                  indicatorsContainer.querySelector('.grid').appendChild(indicatorEl);
              });
          }
  
          function resetDetailedAnalysis() {
              document.getElementById('chart-container').innerHTML = `
                  <div class="h-96 bg-gray-50 flex items-center justify-center">
                      <p class="text-gray-400">Select a stock to see detailed analysis</p>
                  </div>
              `;
              document.getElementById('metrics-container').innerHTML = '';
              document.getElementById('technical-indicators-container').querySelector('.grid').innerHTML = '';
          }
  
          function showStockModal(symbol) {
              const modal = document.getElementById('stock-modal');
              const modalTitle = document.getElementById('modal-title');
              const modalContent = document.getElementById('modal-content');
              
              modalTitle.textContent = `${symbol} - Detailed Analysis`;
              modalContent.innerHTML = '<div class="text-center py-10">Loading...</div>';
              
              modal.classList.remove('hidden');
              
              // Get detailed data for the stock
              if (stockData && stockData.predictions && stockData.predictions[symbol]) {
                  const stockInfo = stockData.predictions[symbol];
                  const tech = stockData.technical_indicators[symbol];
                  const historical = stockData.historical_data[symbol] || [];
                  
                  modalContent.innerHTML = `
                      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                          <div>
                              <h4 class="text-lg font-medium mb-3">Price Prediction</h4>
                              <div class="p-4 bg-gray-50 rounded-lg mb-4">
                                  <div class="flex justify-between items-center mb-3">
                                      <div>
                                          <p class="text-sm text-gray-500">Current Price</p>
                                          <p class="text-xl font-bold">$${stockInfo.latest_price.toFixed(2)}</p>
                                      </div>
                                      <div class="text-right">
                                          <p class="text-sm text-gray-500">Predicted Price</p>
                                          <p class="text-xl font-bold">$${stockInfo.predicted_price.toFixed(2)}</p>
                                      </div>
                                  </div>
                                  <div>
                                      <p class="text-sm text-gray-500 mb-1">Expected Change</p>
                                      <div class="bg-gray-200 rounded-full h-4 relative">
                                          <div class="h-full ${stockInfo.pct_change >= 0 ? 'bg-green-500' : 'bg-red-500'} rounded-full" 
                                              style="width: ${Math.min(Math.abs(stockInfo.pct_change) * 2, 100)}%;"></div>
                                          <div class="absolute inset-0 flex items-center justify-center text-xs font-bold">
                                              ${stockInfo.pct_change >= 0 ? '+' : ''}${stockInfo.pct_change.toFixed(2)}%
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              
                              <h4 class="text-lg font-medium mb-3">Model Confidence</h4>
                              <div class="p-4 bg-gray-50 rounded-lg mb-4">
                                  <div class="mb-3">
                                      <p class="text-sm text-gray-500 mb-1">Prediction Confidence</p>
                                      <div class="flex items-center">
                                          <div class="w-full bg-gray-200 rounded-full h-4 mr-2">
                                              <div class="bg-indigo-600 h-4 rounded-full" style="width: ${(stockInfo.confidence * 100).toFixed(0)}%"></div>
                                          </div>
                                          <span class="ml-2 text-sm font-medium">${(stockInfo.confidence * 100).toFixed(0)}%</span>
                                      </div>
                                  </div>
                                  <div>
                                      <p class="text-sm text-gray-500 mb-1">95% Confidence Interval</p>
                                      <div class="flex justify-between text-sm">
                                          <span>$${stockInfo.lower_bound.toFixed(2)}</span>
                                          <span>$${stockInfo.upper_bound.toFixed(2)}</span>
                                      </div>
                                  </div>
                              </div>
                              
                              <h4 class="text-lg font-medium mb-3">Key Indicators</h4>
                              <div class="grid grid-cols-2 gap-3">
                                  <div class="p-3 bg-gray-50 rounded-lg">
                                      <p class="text-sm text-gray-500">RSI (14)</p>
                                      <p class="text-lg font-medium">${tech.rsi.toFixed(2)}</p>
                                      <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                                          <div class="bg-indigo-600 h-2 rounded-full" style="width: ${tech.rsi}%"></div>
                                      </div>
                                  </div>
                                  <div class="p-3 bg-gray-50 rounded-lg">
                                      <p class="text-sm text-gray-500">MACD</p>
                                      <p class="text-lg font-medium ${tech.macd > 0 ? 'text-green-600' : 'text-red-600'}">
                                          ${tech.macd > 0 ? '+' : ''}${tech.macd.toFixed(2)}
                                      </p>
                                  </div>
                                  <div class="p-3 bg-gray-50 rounded-lg">
                                      <p class="text-sm text-gray-500">Volume Change</p>
                                      <p class="text-lg font-medium ${tech.volume_change > 0 ? 'text-green-600' : 'text-red-600'}">
                                          ${tech.volume_change > 0 ? '+' : ''}${tech.volume_change.toFixed(2)}%
                                      </p>
                                  </div>
                                  <div class="p-3 bg-gray-50 rounded-lg">
                                      <p class="text-sm text-gray-500">50/200 SMA</p>
                                      <p class="text-lg font-medium ${tech.sma_ratio > 1 ? 'text-green-600' : 'text-red-600'}">
                                          ${tech.sma_ratio.toFixed(2)}
                                      </p>
                                  </div>
                              </div>
                          </div>
                          
                          <div>
                              <h4 class="text-lg font-medium mb-3">Factors Influencing Prediction</h4>
                              <div class="p-4 bg-gray-50 rounded-lg mb-4">
                                  <h5 class="font-medium mb-2">Factor Weights</h5>
                                  <div class="space-y-2">
                                      <div>
                                          <div class="flex justify-between text-sm">
                                              <span>Technical Indicators</span>
                                              <span>${(tech.factor_weights.technical * 100).toFixed(0)}%</span>
                                          </div>
                                          <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                                              <div class="bg-blue-500 h-2 rounded-full" style="width: ${(tech.factor_weights.technical * 100).toFixed(0)}%"></div>
                                          </div>
                                      </div>
                                      <div>
                                          <div class="flex justify-between text-sm">
                                              <span>Price Momentum</span>
                                              <span>${(tech.factor_weights.momentum * 100).toFixed(0)}%</span>
                                          </div>
                                          <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                                              <div class="bg-purple-500 h-2 rounded-full" style="width: ${(tech.factor_weights.momentum * 100).toFixed(0)}%"></div>
                                          </div>
                                      </div>
                                      <div>
                                          <div class="flex justify-between text-sm">
                                              <span>Market Sentiment</span>
                                              <span>${(tech.factor_weights.sentiment * 100).toFixed(0)}%</span>
                                          </div>
                                          <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                                              <div class="bg-yellow-500 h-2 rounded-full" style="width: ${(tech.factor_weights.sentiment * 100).toFixed(0)}%"></div>
                                          </div>
                                      </div>
                                      <div>
                                          <div class="flex justify-between text-sm">
                                              <span>Fundamental Analysis</span>
                                              <span>${(tech.factor_weights.fundamental * 100).toFixed(0)}%</span>
                                          </div>
                                          <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                                              <div class="bg-green-500 h-2 rounded-full" style="width: ${(tech.factor_weights.fundamental * 100).toFixed(0)}%"></div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              
                              <h4 class="text-lg font-medium mb-3">Recent News Sentiment</h4>
                              <div class="p-4 bg-gray-50 rounded-lg">
                                  <div class="flex items-center mb-3">
                                      <div class="mr-3">
                                          <div class="flex items-center">
                                              <div class="w-24 bg-gray-200 rounded-full h-3">
                                                  <div class="bg-indigo-600 h-3 rounded-full" style="width: ${(tech.news_sentiment.score * 100).toFixed(0)}%"></div>
                                              </div>
                                              <span class="ml-2 text-sm font-medium">${(tech.news_sentiment.score).toFixed(2)}</span>
                                          </div>
                                      </div>
                                      <span class="text-sm">${tech.news_sentiment.label}</span>
                                  </div>
                                  
                                  <div class="space-y-2 mt-2">
                                      ${tech.news_sentiment.recent_headlines.map(headline => `
                                          <div class="flex items-start p-2 bg-white rounded">
                                              <div class="mr-2 mt-1">
                                                  <i class="fas fa-newspaper text-gray-400"></i>
                                              </div>
                                              <div>
                                                  <p class="text-sm">${headline.title}</p>
                                                  <p class="text-xs text-gray-500">${headline.source} · ${headline.date}</p>
                                              </div>
                                          </div>
                                      `).join('')}
                                  </div>
                              </div>
                          </div>
                      </div>
                  `;
              }
          }
  
          function closeModal() {
              document.getElementById('stock-modal').classList.add('hidden');
          }
  
          function refreshData() {
              document.getElementById('refresh-btn').innerHTML = '<i class="fas fa-sync-alt fa-spin mr-1"></i> Refreshing...';
              
              setTimeout(() => {
                  if (selectedStocks.length > 0) {
                      analyzeSelectedStocks();
                  }
                  
                  // Update last updated time
                  document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                  document.getElementById('refresh-btn').innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Refresh Data';
              }, 1500);
          }
  
          function downloadReport() {
              if (!stockData || Object.keys(stockData.predictions || {}).length === 0) {
                  alert('Please analyze at least one stock before downloading a report');
                  return;
              }
              
              alert('Generating report for download...');
              
              setTimeout(() => {
                  const blob = new Blob([
                      `Stock Prediction Report - ${new Date().toLocaleDateString()}\n\n` +
                      `Analyzed Stocks: ${selectedStocks.join(', ')}\n` +
                      `Timeframe: ${currentTimeframe} day(s)\n\n` +
                      `PREDICTIONS:\n` +
                      Object.entries(stockData.predictions).map(([symbol, data]) => 
                          `${symbol}: Current $${data.latest_price.toFixed(2)} → Predicted $${data.predicted_price.toFixed(2)} (${data.pct_change >= 0 ? '+' : ''}${data.pct_change.toFixed(2)}%)`
                      ).join('\n') +
                      `\n\nRECOMMENDATIONS:\n` +
                      Object.entries(stockData.trading_recommendations).map(([symbol, data]) => 
                          `${symbol}: ${data.action} (Confidence: ${(data.confidence * 100).toFixed(1)}%, Target: $${data.target_price.toFixed(2)})`
                      ).join('\n')
                  ], { type: 'text/plain' });
                  
                  const a = document.createElement('a');
                  a.download = `stock-predictions-${new Date().toISOString().split('T')[0]}.txt`;
                  a.href = window.URL.createObjectURL(blob);
                  a.click();
              }, 1000);
          }
  
          function updateDashboardStats(stats) {
              document.getElementById('last-updated').textContent = stats.last_updated || new Date().toLocaleString();
              document.getElementById('stocks-count').textContent = stats.stocks_analyzed || selectedStocks.length;
              document.getElementById('avg-accuracy').textContent = `${stats.avg_accuracy || '92.4'}%`;
              document.getElementById('market-sentiment').textContent = stats.market_sentiment || 'Neutral';
          }
  
          // Helper functions for technical indicators
          function getRSIStatus(value) {
              if (value > 70) return 'bearish';
              if (value < 30) return 'bullish';
              return 'neutral';
          }
  
          function getMACDStatus(value) {
              if (value > 0) return 'bullish';
              if (value < 0) return 'bearish';
              return 'neutral';
          }
  
          function getSMAStatus(value) {
              if (value > 1.05) return 'bullish';
              if (value < 0.95) return 'bearish';
              return 'neutral';
          }
  
          function getBollingerStatus(value) {
              if (value > 0.9) return 'bearish';
              if (value < -0.9) return 'bullish';
              return 'neutral';
          }
  
          function getADXStatus(value) {
              if (value > 25) return 'trending';
              return 'ranging';
          }
  
          function getStochasticStatus(value) {
              if (value > 80) return 'bearish';
              if (value < 20) return 'bullish';
              return 'neutral';
          }
  
          function getOBVStatus(trend) {
              if (trend === 'up') return 'bullish';
              if (trend === 'down') return 'bearish';
              return 'neutral';
          }
  
          function getTradeAction(symbol, recommendations) {
              if (!recommendations || !recommendations[symbol]) {
                  return { action: 'HOLD', confidence: 0.5 };
              }
              return recommendations[symbol];
          }
      });
  </script>
</body>
</html>